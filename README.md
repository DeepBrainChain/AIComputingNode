# InferenceComputingNetwork

Distributed Inference Computing Network for Text-to-Image Generation

## Table of Contents

- [`Compiling`](#compiling)
- [`Protobuf`](#protobuf)
- [`Command Line`](#command-line)
- [`Configuration`](#configuration)
  - [`Client Configuration Example`](#client-configuration-example)
  - [`Server Configuration Example`](#server-configuration-example)
- [`Tools`](#tools)
  - [`PeerKey`](#peerkey)
  - [`PSK`](#psk)
- [`HTTP API`](#http-api)

## Compiling

```shell
$ go mod tidy
$ version=$(git describe --tags)
$ go build -ldflags "-X main.version=$version" -o host host\main.go
```

## Protobuf

```shell
# install to ~/go/bin/
$ go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
$ protoc -I=./pkg/protocol/ --go_out=./pkg/protocol/ ./pkg/protocol/protocol.proto 
protoc-gen-go: program not found or is not executable
--go_out: protoc-gen-go: Plugin failed with status code 1.
$ export PATH=$PATH:/home/dbtu/go/bin
$ protoc -I=./pkg/protocol/ --go_out=./pkg/protocol/ ./pkg/protocol/protocol.proto 
```

## Command Line

```shell
$ host -config ./config.json [-version]
```

- config: Specify the json configuration file path of the program
- version: Show version number and exit

## Configuration

```json
{
  // Boot node list, used for node routing and discovery functions, needs to be deployed on
  // a public network server, preferably with a domain name
  "Bootstrap": [
    "/ip4/122.99.183.54/tcp/6001/p2p/12D3KooWSpgWzEXE5GNjY6hgdAhuuBLe4d3ocqWDnVLdCa8U3cig",
    "/ip4/82.157.50.32/tcp/6001/p2p/12D3KooWFrTcDtocZWEvEAk2X4poyn13LzT3G7JMBRoPD73YPAoB"
  ],
  // Listening address for node connection communication
  "Addresses": [
    "/ip4/0.0.0.0/tcp/6001",
    "/ip6/::/tcp/6001"
  ],
  // API that provides HTTP services
  "API": {
    // Provided in the form ":port number"
    "Addr": ":6000"
  },
  // The identity information of the node is generated by the peer-key tool. The following is
  // just an example. Please generate and fill it out by yourself during actual deployment.
  // PeerID is generated by algorithm using public key, and the program will verify whether
  // PeerID and PrivKey match.
  "Identity": {
    // Node ID of the node
    "PeerID": "12D3KooWLzae3a7n7eJSQbSgARHQizJzChS4Rtpo3gziugpV4vRz",
    // Node’s private key
    "PrivKey": "CAESQBOuYLpTajlQ0Xzh84i6ey0Zot24Tc2qA2yDgw7dd2vGpg53BtN+RQgJ2erx2lRgDo4BiOXy0ZFRRxIZRQ5wJ3U="
  },
  // Configure node connection parameters
  "Swarm": {
    // Connection manager
    "ConnMgr": {
      // Type of connection manager
      // "basic" - Basic manager with parameters such as "HighWater" "LowWater"
      // "none" - Not using a connection manager
      "Type": "basic",
      // GracePeriod is a time duration that new connections are immune from being closed by
      // the connection manager.
      "GracePeriod": "20s",
      // When a node using the basic connection manager reaches HighWater idle connections,
      // it will close the least useful ones until it reaches LowWater idle connections.
      "HighWater": 400,
      "LowWater": 100
    },
    // Disable automatic NAT port forwarding.
    // When not disabled (default), the local node asks NAT devices (e.g., routers), to open up
    // an external port and forward it to the port node is running on. When this works (i.e., when
    // your router supports NAT port forwarding), it makes the local node accessible from the
    // public internet.
    "DisableNatPortMap": false,
    // Configuration options for the relay client to use relay services.
    "RelayClient": {
      // Enables "automatic relay user" mode for this node.
      // If the node is deployed on a public server, please disable it, otherwise enable it.
      "Enabled": true,
      "StaticRelays": []
    },
    // Configuration options for the relay service that can be provided to other peers on the network
    "RelayService": {
      // Enables providing `/p2p-circuit` v2 relay service to other peers on the network.
      // If the node is deployed on a public server, please enable it, otherwise disable it.
      "Enabled": false
    },
    // Experimental
    // Enable hole punching for NAT traversal when port forwarding is not possible. (default: disabled)
    // When enabled, the local node will coordinate with the counterparty using a relayed connection,
    // to upgrade to a direct connection through a NAT/firewall whenever possible. This feature
    // requires Swarm.RelayClient.Enabled to be set to true.
    "EnableHolePunching": false,
    // If you want to help other peers to figure out if they are behind NATs, you can launch the
    // server-side of AutoNAT too (RelayClient already runs the client).
    // This configures the node to provide a service to peers for determining their reachability status.
    // If the node is deployed on a public server, please enable it, otherwise disable it.
    // This service is highly rate-limited and should not cause any performance issues.
    "EnableAutoNATService": true
  },
  // Publish and subscribe configuration
  "Pubsub": {
    // Enabled by default
    "Enabled": true,
    // Route type, default "gossipsub"
    // "floodsub" - floodsub is a basic router that simply floods messages to all connected peers.
    // This router is extremely inefficient but very reliable. Suitable for small networks with few nodes.
    // "gossipsub" - gossipsub is a more advanced router with mesh formation and gossip propagation.
    // Suitable for large networks with many nodes.
    "Router": "gossipsub",
    // Use flood publishing in "gossipsub" to send messages to all peers with a score greater than publishThreshold.
    "FloodPublish": true
  },
  // Node routing configuration
  "Routing": {
    // Route type, one of the following options
    // "dhtclient" - Client mode, suitable for nodes behind NAT
    // "dhtserver" - Server mode, suitable for nodes deployed on public network servers
    // "auto" - Automatically determine client mode or server mode based on network conditions
    // "none" - Not using DHT routing to discover other nodes
    "Type": "dhtclient",
    // The prefix of the routing protocol. Nodes with different protocols cannot establish connections.
    "ProtocolPrefix": "/DeepBrainChain"
  },
  // Application configuration
  "app": {
    // Log level, one of "debug"、"info"、"warn"、"error"、"panic" and "fatal"
    "LogLevel": "info",
    // Log file path, used to save log records generated by the program
    "LogFile": "./test.log",
    // Log output mode, freely combined by "stderr", "file" or "+"
    // "stderr" - output to console
    // "file" - Output to the file specified by "LogFile"
    // "stderr+file" - Output to the console and the specified file at the same time
    "LogOutput": "stderr+file",
    // Pre-generated shared key, nodes with different keys cannot establish connections
    "PreSharedKey": "f504f536a912a8cf7d00adacee8ed20270c5040d961d7f3da4fccbcbec0ec48a",
    // The subscribed topic name, used for centralized node query services, such as querying
    // the Node ID list of all nodes in the network.
    // Different topic names may prevent others from querying the node you deployed.
    "TopicName": "SuperImageAI",
    // The data storage folder persists the successfully connected peer information and other
    // information to facilitate the node to quickly reconnect to the network when it starts.
    // Please create this folder in advance and ensure that this node program has read and
    // write permissions.
    "Datastore": "./datastore"
  }
}
```

### Client Configuration Example

```json
{
  "Bootstrap": [
    "/ip4/122.99.183.54/tcp/6001/p2p/12D3KooWSpgWzEXE5GNjY6hgdAhuuBLe4d3ocqWDnVLdCa8U3cig",
    "/ip4/82.157.50.32/tcp/6001/p2p/12D3KooWFrTcDtocZWEvEAk2X4poyn13LzT3G7JMBRoPD73YPAoB"
  ],
  "Addresses": [
    "/ip4/0.0.0.0/tcp/6001",
    "/ip6/::/tcp/6001"
  ],
  "API": {
    "Addr": ":6000"
  },
  "Identity": {
    "PeerID": "12D3KooWLzae3a7n7eJSQbSgARHQizJzChS4Rtpo3gziugpV4vRz",
    "PrivKey": "CAESQBOuYLpTajlQ0Xzh84i6ey0Zot24Tc2qA2yDgw7dd2vGpg53BtN+RQgJ2erx2lRgDo4BiOXy0ZFRRxIZRQ5wJ3U="
  },
  "Swarm": {
    "ConnMgr": {
      "Type": "none",
      "GracePeriod": "20s",
      "HighWater": 400,
      "LowWater": 100
    },
    "DisableNatPortMap": false,
    "RelayClient": {
      "Enabled": true,
      "StaticRelays": []
    },
    "RelayService": {
      "Enabled": false
    },
    "EnableHolePunching": true,
    "EnableAutoNATService": true
  },
  "Pubsub": {
    "Enabled": true,
    "Router": "gossipsub",
    "FloodPublish": true
  },
  "Routing": {
    "Type": "dhtclient",
    "ProtocolPrefix": "/DeepBrainChain"
  },
  "app": {
    "LogLevel": "info",
    "LogFile": "./test.log",
    "LogOutput": "stderr+file",
    "PreSharedKey": "f504f536a912a8cf7d00adacee8ed20270c5040d961d7f3da4fccbcbec0ec48a",
    "TopicName": "SuperImageAI",
    "Datastore": "./datastore"
  }
}
```

### Server Configuration Example

```json
{
  "Bootstrap": [
    "/ip4/122.99.183.54/tcp/6001/p2p/12D3KooWSpgWzEXE5GNjY6hgdAhuuBLe4d3ocqWDnVLdCa8U3cig",
    "/ip4/82.157.50.32/tcp/6001/p2p/12D3KooWFrTcDtocZWEvEAk2X4poyn13LzT3G7JMBRoPD73YPAoB"
  ],
  "Addresses": [
    "/ip4/0.0.0.0/tcp/6001",
    "/ip6/::/tcp/6001"
  ],
  "API": {
    "Addr": ":6000"
  },
  "Identity": {
    "PeerID": "12D3KooWLzae3a7n7eJSQbSgARHQizJzChS4Rtpo3gziugpV4vRz",
    "PrivKey": "CAESQBOuYLpTajlQ0Xzh84i6ey0Zot24Tc2qA2yDgw7dd2vGpg53BtN+RQgJ2erx2lRgDo4BiOXy0ZFRRxIZRQ5wJ3U="
  },
  "Swarm": {
    "ConnMgr": {
      "Type": "basic",
      "GracePeriod": "20s",
      "HighWater": 400,
      "LowWater": 100
    },
    "DisableNatPortMap": true,
    "RelayClient": {
      "Enabled": false,
      "StaticRelays": []
    },
    "RelayService": {
      "Enabled": true
    },
    "EnableHolePunching": false,
    "EnableAutoNATService": true
  },
  "Pubsub": {
    "Enabled": true,
    "Router": "floodsub",
    "FloodPublish": true
  },
  "Routing": {
    "Type": "dhtserver",
    "ProtocolPrefix": "/DeepBrainChain"
  },
  "app": {
    "LogLevel": "info",
    "LogFile": "./test.log",
    "LogOutput": "stderr+file",
    "PreSharedKey": "f504f536a912a8cf7d00adacee8ed20270c5040d961d7f3da4fccbcbec0ec48a",
    "TopicName": "SuperImageAI",
    "Datastore": "./datastore"
  }
}
```

## Tools

### PeerKey

Read the key file path specified by the command line parameter `-peerkey`, parse and display the private key/public key in the key, and convert it into the corresponding PeerID.

If the key file specified by the command line parameter `-peerkey` does not exist, a new key is created at this file path.

```shell
$ ./peer-key -peerkey ./peer.key
2024/03/28 18:58:12 Generate peer key success
2024/03/28 18:58:12 Encode private key: CAESQBOuYLpTajlQ0Xzh84i6ey0Zot24Tc2qA2yDgw7dd2vGpg53BtN+RQgJ2erx2lRgDo4BiOXy0ZFRRxIZRQ5wJ3U=
2024/03/28 18:58:12 Encode public key: CAESIKYOdwbTfkUICdnq8dpUYA6OAYjl8tGRUUcSGUUOcCd1
2024/03/28 18:58:12 Transform Peer ID: 12D3KooWLzae3a7n7eJSQbSgARHQizJzChS4Rtpo3gziugpV4vRz
$ ./peer-key -peerkey ./peer.key
2024/03/29 09:59:55 Load peer key success
2024/03/29 09:59:55 Encode private key: CAESQBOuYLpTajlQ0Xzh84i6ey0Zot24Tc2qA2yDgw7dd2vGpg53BtN+RQgJ2erx2lRgDo4BiOXy0ZFRRxIZRQ5wJ3U=
2024/03/29 09:59:55 Encode public key: CAESIKYOdwbTfkUICdnq8dpUYA6OAYjl8tGRUUcSGUUOcCd1
2024/03/29 09:59:55 Transform Peer ID: 12D3KooWLzae3a7n7eJSQbSgARHQizJzChS4Rtpo3gziugpV4vRz
```

### PSK

Generate a random 64-bit string as the Pre-Shared Key, which is different every time.

***Remember: Nodes with different Pre-Shared Key cannot communicate with each other.***

```shell
$ ./psk
2024/03/29 15:09:49 Generate Pre-Shared key: 4628f17e14cb496a9a3c85d774df1d1f4147098327e006e4a01ef75c1bcbcef4
$ ./psk
2024/03/29 15:09:52 Generate Pre-Shared key: 20b580ada44043b9d7b78b02db10d2ae07ea777019c232203558f02da3d91922
$ ./psk
2024/03/29 15:09:54 Generate Pre-Shared key: a0d245d95cf60826d5d18b5cbfe6e9a9f9b119a256d76d6873b497976d5acf2e
```

## HTTP API

[Rest HTTP API](./api.http)

Developer invites you to join team DBC in Apifox: https://app.apifox.com/invite?token=XJYVYIvuR6VDnQCKJfIqV
